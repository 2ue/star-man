services:
  star-man:
    image: ghcr.io/2ue/star-man:latest
    container_name: star-man
    restart: unless-stopped

    environment:
      NODE_ENV: production
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      DATABASE_URL: file:///app/data/star-man.db
      API_PORT: 3801
      API_HOST: 0.0.0.0

      # AI 功能配置
      AI_ENABLED: ${AI_ENABLED:-false}
      AI_MODEL: ${AI_MODEL:-ollama}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.2}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-starred_repos}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-ollama}
      EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-768}

    ports:
      - "${HOST_PORT:-3800}:3800"  # Web UI + API (通过 nginx 反向代理)

    volumes:
      - ./data:/app/data

    # 如果启用 Qdrant，添加依赖
    # depends_on:
    #   - qdrant

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3800/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Qdrant 向量数据库（可选，如果启用 AI 功能）
  # 取消注释以启用
  # qdrant:
  #   image: qdrant/qdrant:latest
  #   container_name: star-man-qdrant
  #   restart: unless-stopped
  #   ports:
  #     - "6333:6333"
  #     - "6334:6334"
  #   volumes:
  #     - ./data/qdrant:/qdrant/storage
  #   environment:
  #     QDRANT__SERVICE__GRPC_PORT: 6334
